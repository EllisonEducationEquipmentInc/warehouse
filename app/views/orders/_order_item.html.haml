%tr{:id => "order_item_#{order_item.product_id_with_start_date}", :class => "order_item_row order_item_#{order_item.product_id_with_start_date}", "data-product-item_num" => order_item.product.item_num, :'data-ship-date' => ((order_item.ship_month || order_item.product.start_date_or_today).strftime("%B %Y") rescue '')}
  = fields_for "order[order_items_attributes][#{order_item.order.blank? ? "#{Time.now.to_i}#{rand(1000)}" : order_item.order.order_items.index(order_item)}]", order_item, :child_index => "new_order_item" do |order_item_fields|
    %td
      = order_item_fields.hidden_field :product_id, class: :product_id
      = order_item.product.item_num
    %td
      = raw order_item.product.name
    - if tradeshow?
      %td{ :align => 'right'}= l order_item.product.start_date, :format => :month_only rescue ''
      %td{:align => 'right'}
        - if @editable
          = order_item_fields.select :ship_month, ship_date_select(order_item.product.start_date_or_today), {}, class: 'ship-date', data: { order_item_id: order_item.product.id }
        - else
          = l order_item.ship_month, :format => :month_only rescue ''
    %td{:align => 'right'}= @editable ? order_item_fields.text_field(:quantity, :size => 2, :id => "order_order_item_attributes_#{order_item.product.id_with_start_date}_quantity", :class => 'quantity', :onchange => "update_totals();$('#upc').focus();") : order_item.quantity
    - if tradeshow?
      %td{:align => 'right'}
        = number_to_currency(order_item.product.price)
    %td{:align => 'right'}
      - if @editable && tradeshow?
        = order_item_fields.text_field(:price, :size => 6, :class => 'price', :onchange => "update_totals();$('#upc').focus();")
      - else
        = order_item_fields.hidden_field :price, :class => 'price' if @editable && warehouse?
        = number_to_currency(order_item.price)
    %td{:align => 'right', :class => "item_total"}= number_to_currency order_item.item_total
    - unless params[:action] == 'show'
      %td{ :align => 'right'}= link_to 'x', '#', :onclick => "$(this).parents('.order_item_row').remove();update_totals();return false" 
      - if tradeshow?
        %td{:align => 'right'}= link_to 'dup', '#', class: 'dup', data: {'item-num' => order_item.product.item_num}

:coffee
  $('.dup').on 'click', ->
    $.ajax(
      url: '/orders/add_item'
      method: 'POST'
      data:
        dup: true
        upc: $(@).data('item-num')
      context: document.body).done ->
      $(this).addClass 'done'
    return false

  $('.ship-date').on 'change', ->
    tr = $(@).parents('tr')
    tr.attr('id', 'order_item_'+$(@).data('order-item-id')+'-'+$(@).val())
    tr.data('ship-date', $(@).children("option:selected").text())
    update_totals()
    false
